@using System.Security.Claims
@{
    int idcv = int.Parse(User.FindFirstValue(ClaimTypes.Locality));
    QuanLyNhanVienContext context = new QuanLyNhanVienContext();

    string formatDay(DateTime? date)
    {
        if (date != null)
        {
            return date.Value.ToString("dd/MM/yyyy");
        }
        else
        {
            return null;
        }
    }
   
}
@if (TempData["ThongBao"] != null)
{
    <script type="text/javascript" charset="utf-8">
                        window.onload = function () {
                            alert("@Html.Raw(@TempData["ThongBao"])");
                    };
    </script>
}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="card">
            <div class="card-body">
                <div class="row position-absolute" style="margin-top: -10px">
                    <div class="col-sm-auto pe-2">
                        <a href="/NhanSu/ThemNhanSu" class="btn btn-primary">
                            <span>Thêm Mới</span>
                        </a>
                    </div>
                    <div class="col-sm-auto pe-2">
                        <select class="form-select" name="" id="TinhTrang">
                            <option value="1" selected>Hiện tại</option>
                            <option value="2">Đã xóa</option>
                        </select>
                    </div>
                </div>
                <div>
                <table id="example"
                       class="display table table-bordered"
                       style="width: 100%;">
                    <thead>
                        <tr>
                            <th class="">Mã NS</th>
                            <th class="text-center">Ảnh</th>
                            <th class="text-center">Tên</th>
                            <th class="text-center">Ngày sinh</th>
                            <th class="">Địa chỉ</th>
                            <th class="text-center">giới tính</th>
                            <th class="text-center">SĐT</th>
                            <th class="text-center">Email</th>
                            <th class="text-center">Quê quán</th>
                            <th class="text-center">Tùy chọn</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ns in  ViewBag.NhanSu)
                        {
                            <tr class="text-nowrap">
                                <td class="text-center">@ns.MaNs</td>
                                <td class="text-center p-1">
                                    <img height="45px"
                                         width="45px"
                                         src="@ns.HinhAnh"
                                         alt="ảnh nhân sự" />
                                </td>
                                <td class="text-start">@ns.TenNs</td>
                                <td class="text-center">@formatDay(@ns.NgaySinh)</td>
                                <td class="text-center">@ns.DiaChi</td>
                                <td class="text-center">@(ns.GioiTinh ?? false ? "Nam" : "Nữ")</td>
                                <td class="text-center">@ns.Sdt</td>
                                <td class="text-center">@ns.Email</td>
                                <td class="text-center">@ns.QueQuan</td>
                                <td class="text-center">
                                    <div class="dropdown">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bx bx-dots-vertical-rounded"></i>
                                        </button>
                                        <div class="dropdown-menu" style="">
                                            <a class="dropdown-item" href="/NhanSu/SuaNhanSu/@ns.Id"><i class="bx bx-edit-alt me-1"></i>Chỉnh sửa</a>
                                            <a class="dropdown-item" href="/NhanSu/XoaNhanSu/@ns.Id" onclick="return confirm('Bạn có xoá nhân sự này?')"><i class="bx bx-trash me-1"></i>Xóa</a>
                                            <a class="dropdown-item" href="/NhanSu/ChiTietNhanSu/@ns.Id"  ><i class="bx bx-low-vision me-1"></i>Xem</a>
                                            
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function formatDay(inputString) {
  if (inputString) {
      var inputDate = new Date(inputString);
      var day = inputDate.getDate();
      if (day < 10) {
          day = '0' + day;
      }
      var month = inputDate.getMonth() + 1;
      if (month < 10) {
          month = '0' + month;
      }
      var year = inputDate.getFullYear();
      return day + '-' + month + '-' + year;
  } else {
      return ""
  }
}
     $('#TinhTrang').on('change', function() {
        var TrangThai = $(this).val();
        console.log(TrangThai)
        $.ajax({
        type: "post",
        url: "/NhanSu/DoiTrangThai",
        data: "trangthai=" + TrangThai,
        success: function (response) {
             var table = $('#example').DataTable();
        // Clear existing rows from the DataTable
        table.rows().remove().draw();
      $.each(response, function (index, ns) {
    var row = `<tr class="text-nowrap">
                                <td class="text-center">${ns.maNs}</td>
                                <td class="text-center p-1">
                                    <img height="45px"
                                         width="45px"
                                         src="${ns.hinhAnh}"
                                         alt="ảnh nhân sự" />
                                </td>
                                <td class="text-start">${ns.tenNs}</td>
                                <td class="text-center">${formatDay(ns.ngaySinh)}</td>
                                <td class="text-center">${ns.diaChi}</td>
                                <td class="text-center">${ns.gioiTinh ?? false ? "Nam" : "Nữ"}</td>
                                <td class="text-center">${ns.sdt}</td>
                                <td class="text-center">${ns.email}</td>
                                <td class="text-center">${ns.queQuan}</td>
                                <td class="text-center">
                                    <div class="dropdown">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bx bx-dots-vertical-rounded"></i>
                                        </button>
                                        <div class="dropdown-menu" style="">
                                            <a class="dropdown-item" href="/NhanSu/SuaNhanSu/${ns.id}"><i class="bx bx-edit-alt me-1"></i>Chỉnh sửa</a>
                                           
                                            ${ns.active ?  `<a class="dropdown-item" href="/NhanSu/XoaNhanSu/${ns.id}" onclick="return confirm('Bạn có xoá nhân sự này?')"><i class="bx bx-trash me-1"></i>Xóa</a>`:
                                            `<a class="dropdown-item" href="/NhanSu/KhoiPhuc/${ns.id}" onclick="return confirm('Bạn có khôi phục nhân sự này?')"><i class="bx bx-redo me-1"></i>Hoàn tác</a>`
                                            }
                                            <a class="dropdown-item" href="/NhanSu/ChiTietNhanSu/${ns.id}"  ><i class="bx bx-low-vision me-1"></i>Xem</a>
                                            
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
            // Thêm dòng mới vào DataTable và vẽ lại DataTable
            $('#example').DataTable().row.add($(row)[0]).draw(false);
        });
        },
        error: function (error) {
            console.log(error);
        }
    });
    })
</script>